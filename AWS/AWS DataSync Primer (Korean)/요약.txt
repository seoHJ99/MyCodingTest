DataSync : AWS Cloud 스토리지 서비스에서 송수신되는 데이터의 복사를 간소화, 자동화, 가속화하는 관리형 서비스
데이터 전송에 사용됨.
단방향 데이터 복사 또는 동기화 작업을 지원
NFS(네트워크 파일 시스템) 및 SMB(서버 메시지 블록) 파일 시스템 프로토콜을 지원
NAS 지원
s3 api 와 호환
여러 리전 걸쳐 사용 가능
S3, FSx, EFS 지원
데이터 전송 태스크는 소스 스토리지 위치와 대상 스토리지 위치 간 단방향 전송
인라인 압축 및 스파스 파일 탐지
인라인 데이터 암호화 및 검증
체크섬을 이용하여 무결성 검사를 통환 일관성 검증


용어 및 구성요소
에이전트 : 데이터를 읽거나 쓰기 위한 가상 시스템.
    - 온프레미스에서는 vm
    - 클라우드에서는 ami 를 사용하는 ec2 인스턴스를 사용하여 배포
    - aws 스토리지간 전송은 에이전트가 필요 없음

배포 방식을 선택하여 에이전트 숫자를 결정 가능
많은 소스 : 1개의 에이전트 - 순차적 가능
1개 소스 : 1개 에이전트 
1개 소스 : 많은 에이전트 - 빠름

통신 가능하면 온라인.

태스크 구성요소
위치, 옵션, 필터링, 일정 예약 및 빈도, 태그, 로깅

위치 : 전송할 파일 위치와 전송될 위치
옵션 : 덮어쓸지, 소유권은 어쩔지 등
필터링(선택) : 제외, 추가 등 필터
예약(선택) 및 빈도 : 언제 시작할지, 빈도
태그(선택) : 관리를 위한 태그값
로깅(선택) : 로그 기록

삭제된 파일 보관 옵션은 말 그대로.
덮어쓰기 역시 선택 안하면 복사 자체를 안함.


태스크 실행 구조
1. 대기열
2. 시작
3. 준비 - 파일 크기 계산
4. 전송
5. 검증
6. 4~5 반복
7. 모두 끝나면 성공 또는 실패

개방형 파일을 제한 없이 전송
전송 중에 파일이 열려 있고 기록되는 중인 경우 DataSync는 확인 단계에서 데이터 불일치를 탐지하고 파일을 실패로 처리

소스 시스템에서 파일을 열 수 없으면 DataSync는 파일 전송을 건너뜀
전송 단계에서 오류를 기록하고 전송


아키텍처
1. 온프레미스에서 aws 스토리지간 전송. 에이전트 필요
    - NFS 또는 SMB 파일 공유 또는 S3 API 호환 객체 데이터만 가능
    - NFS 또는 SMB 파일 공유 또는 S3 API 호환 객체 스토리지가 있는 곳에 에이전트 배포
    - 퍼블릭 엔드포인트 사용 가능
    - FIPS 엔드포인트 사용 가능. 미국 동부 또는 미국 서부 리전 액세스시 fips 검증화 모듈이 필요한 경우
    - vpc 엔드포인트 사용 가능. 
    -  256비트 AES 로 암호화

2. 클라우드 내 aws 스토리지간 전송
    - s3, EFS, FSx 가 지원됨
    - 에이전트 X
    - 서로 다른 리전 가능
    - 액세스 필요
    - 추가 서비스 요금 발생

3. 클라우드 내 자체 관리형 NFS 또는 SMB 공유와 AWS 스토리지 간 전송
    - 온프레미스 -> aws 와 유사
    - nfs 또는 SMB 공유 파일이 상주하는 aws 리전 및 aws 계정에 에이전트 배포
    - 에이전트는 aws 리전용 ec2 ami 를 사용
    - 온프레미스처럼 퍼블릭 엔드포인트, FIPS, vpc 엔드포인트 사용 가능
    - 대상 aws 스토리지 서비스는 AWS KMS 와 통합되어 데이터 암호화 관리. DataSync에는 전송을 위해 읽기 및 쓰기 권한 부여


DataSync 요구 사항
온프레미스의 에이전트 : 1. 지원되는 하이퍼바이저   2. 가상머신
클라우드의 에이전트 : 에이전트가 포함된 ami 를 실행할수 있는 리소스 (최소 2xlarge 이상)
공통: 네트워크 포트 개방


다른 서비스와 통합
* 네트워크
1. AWS Site-to-Site VPN
    - 전송 네트워크 성능을 최적화
    - 암호화된 트래픽을 위해 IPsec(인터넷 프로토콜 보안) 연결을 지원
2. AWS Direct Connect
    - 안전하고 전체 대역폭 사용 가능
* 보안
1. IAM
   - iam 정책을 생성하여 iam 사용자와 연결하는 방식으로 보호
* 기록
1. CloudWatch
    - 5분 간격으로 자동 데이터 전송
    - 성능 모니터링
2. CloudTrail
    - 지속적으로 s3 버킷에 전송
    - 자동으로 CloudTrail 콘솔의 Event History 에서 최신 이벤트 확인 가능
    - 요청자, 수행 내용 등 확인 가능
    
추가 요금이 발생할수 있으며 DataSync 요금 계산기로 비용 추정 가능


실습
1. 옳바른 리전 선택
2. 데이터가 전송될 s3 버킷 생성
3. 데이터를 전송할 ec2에 NFS 또는 SMB 공유 파일이 있는지 확인(ec2 -> 클라우드 경우)
4. DataSync 에이전트 생성. aws 설명성 각 리전별 에이전트 ami 를 제공.
5. 옳바른 인스턴스 타입 선택. 최소 2xlarge 이상
6. 소스 nfs 서버가 있는 vpc 선택. 서브넷도 선택. 자동 퍼블릭 ip 사용 가능하도록 설정
7. 추가 스토리지 선택(선택사항)
8. 태그 선택(선택)
9. 보안그룹 선택. 필요한 포트를 열어야함. 
10. 시작. 키페어를 선택하거나 선택하지 않음. 인스턴스 배포
11. 인스턴스에 ip 주소가 할당되면 서비스 엔드 포인트 선택.
12. agent address 에 자기 인스턴스의 퍼블릭ip 주소 등록. 연결이 되면 포트 80이 닫히고 더이상 액세스 불가능
13. 에이전트 이름 및 태그 설정
14. 에이전트가 생성 끝

----전송

1. crate task 선택
2. 새 위치 선택. 이전에 nfs 타입. agent. nfs 서버의 private ip. nfs 서버 탑재 경로 입력
3. 대상 위치 선택. 여기서는 s3
4. 맞는 버킷 선택. 필요하면 접두사도 입력
5. IAM 역할을 선택. 자동 생성되도록 자동 생성도 가능.
6. 태스크 이름, 옵션 선택. 태깅도 가능
7. CloudWatch를 이용해 기록도 가능
8. 기다렸다가 start 를 선택
9. 태스크 실행 세부정보, 단계, 지속시간 등 확인 가능
10. 정상적으로 파일 전송되었는지 확인
11. 