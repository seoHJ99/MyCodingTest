aws mgn
mgn 콘솔을 통해 접근 가능한 리프트 앤 시프트 솔루션.
데이터를 블록수준에서 복제.

기본원리
1. 원본 서버가 따로 돌아가고, 마이그레이션 서버도 돌아감
2. 복제
3. 시작 설정 하고 마이그레이션 정상 작동하는지 테스트
4. 모두 정상이면 원본 서버 다운. 마이그레이션 작동

복제 경로는 사용자가 관리
자동으로 수시로 교체됨.
1. 복제서버는 기본적으로 t3.small linux 인스턴스 사용
2. 하나의 복제 서버는 동시에 복제하는디스크가 15개
3. aes265키를 이용해 데이터 암호화

기술적 구조
1. 원본 서버와 mgn 과 https 통신을 통해 연결
2. s3에 있는 구성 요소 내용을 알아야하기에 이것도 연결
3. 원본 서버와 복제 서버간의 연결. 1500포트
4. 복제 서버와 mgn 간의 지속적으로 연결. 변환 서버 작동을 위해. s3연결도 필요. https 연렬
5. 변환 서버와 연결되면 s3 버킷에서 구성 파일 다운
6. 복제 중에 ebs 볼륨의 스냅샷 생성. 이를 위해 ec2 api 엔드 포인트와 연결되야 함.

실습 용어
1. aws 복제 에이전트 : 원본 시스템에 실치되는 작은 소프트웨어로 원본 데이터를 aws로 전송
2. 복제 서버 : ec2 인스턴스 등으로 에이전트에서 데이터를 수신하고 ebs 볼륨에 데이터를 저장
3. 준비 영역 서브넷 : 모든 원본 데이터가 복제되는 vpc 내의 서브넷
4. 전환 서버 : ec2 서버를 기본적으로 실행할수 있또록 변경 사항을 구현하는 서버


0단계 : 필수 구성 요소
    원본 서버는 s3에 접근해서 에이전트 설치 프로세스에 필요한 추가 구성 요소를 다운
    mgn api 와 443포트로 통신.
    준비영역 서브넷에 연결하기 위해 1500 포트를 염

    준비영역 서브넷은 1500포트 허용
    s3로부터 필요한 소프트웨어를 다운받기 위해 443포트 열어서 mgn api 와 연결
    ec2 api 엔드포인트와도 연결

1단계 : IAM 사용자 생성
    1. iam 대시보드에서 user -> add user -> programmatic access 체크
    2. attach existing policies directly -> migrationAgentPolicy 선택 -> 다음
    3. 필요하면 태그만들고 유저 생성. 비밀번호 다운 또는 복사

2단계 : aws mgn 콘솔 액세스
    mgn 선택, start 클릭

3단계 : 복제 설정 탬플릿 구성
    1. 복제 설정 템플릿 생성(새로 추가된 각 원본 서버에 대해 데이터 복제가 정의되는 방식)
    2. 복제 서버 설정. 원본이 느리다면 500gib 이상인 느린 ebs 사용 가능. 암호화 여부 선택 가능
    3. 복제 서버에 적용할 기본 보안 그룹 선택. 기본은 tcp 1500포트를 염
    4. 데이터 라우팅 및 속도 제한. 프라이빗 ip 를 선택 가능.
    5. 복제 리소스에 사용자 지정 태그 추가 가능

4단계 : AWS 복제 에이전트 설치
    1. ec2 대시보드에서 mgn workshop training 찾음. ami 소유자가 같은지 확인.
    2. source servers 페이지에서 addServer 를 선택하여 에이전트 설치 관리자 링크를 가져옴
    3. 원본 서버에서 ssh 프로토콜에 사용자 이름과 ec2키 페어와 함께 서버에 연결
    4. 서버에서 에이전트 설치 관리자 다운로드 명령어를 붙여넣기 (파이선 설치 필요)
    5. 안내문에 나오는 설치 관리자 명령어 붙여넣기. 메시지에 따라 액세스 키와 비밀키, 리전을 적어줌
    6. 설치가 끝나면 source servers 웹 콘솔에 서버가 표시됨. 초기 동기화 진행됨
           - 방화벽 실행, 복제 소프트웨어 다운로드 볼륨 생성, 복제 서버 가동, mgn 인증, 에이전트와 서버 통신 연결
        원본 서버는 설치에서 전환까지의 수명 주기를 거침.
        - 복제가 끝나면 ready for testing 상태. 여기서 테스트 인스턴스 실행 가능.
        - finalize cutover 가 되면 mgn 에서 사용한 모든 리소스가 지워짐
    
5단계 : WordPress 콘텐츠 작성(선택사항)
    - 아마도 데이터가 실시간으로 변동되는 것도 적용되는지 확인 용도

6단계 : 시작 설정 구성
    테스트 또는 전환 인스턴스가 실행되는 방법을 결정함.
    1. source servers 페이지에서 launch setting 선택
    2-1. (일반 시작 설정으로 구성) general launch setting edit 선택. instance size right sizing 을 켜두면 인스턴스 크기를 하드웨어 맞게 재정의
    2-2. (ec2 시작 템플릿 구성) ec2 launch setting edit 선택. ec2 시작 템플릿 구성
    3. 네트워크 인터페이스 섹션에서 외부 ip 허용 여부 등을 선택하고 템플릿 저장
    4. mgn 시작 템플릿은 시작 템플릿이기에, 만든 템플릿을 기본 버전으로 선택.
    5. mgn 콘솔로 복귀

7단계 : 테스트 인스턴스 시작
    source servers 에 서버 상태가 정상인지 확인. machine lifecycle 에 ready for testing 이 표시되어야 함
    1. 서버를 선택하고 test and cutover 에서 launch test instances 클릭
    2. source servers 에 alerts 열에 launched 가 표시되는지, migration lifecycle 에 test in progress 인지, next step 열이 complete testing 인지 확인
    3. 원본 서버 호스트 이름 선택. migration dashboard 의 launch status 가 success 인지 확인. 이 인스턴스를 ec2 콘솔에서 확인
    4. 해당 인스턴스 ip 를 복사해서 접근. 정상 페이지 나오는지 확인
    5. 테스트 실패하면 source servers에서 다시 revert to "ready for test" 로 선택.
       성공하면 mark as "ready for cutover" 로 선택
    6. finalizing test 를 하면서 테스트 인스턴스도 모두 종료

8단계 : 전환 인스턴스 시작
    1. 서버를 선택하고 launch cutover instance 를 선택. launch
    2. 전환작업이 완료됬는지 확인. launch 인지, finalize cutover 인지 확인
    3. 서버 디테일의 migration dashboard 에서 succeeded 인지 확인. ec2로 이동
    4. ip 를 복사해서 전환에 성공했는지 확인.
    5. 전환에 실패하면 revert to "ready fo cutover" 선택
       성공하면 finalize cutover 선택
    6. 전환이 끝나면 복제된 데이터가 모두 폐기되고 복제에 사용된 리소스가 모두 종료됨

9단계 : 최종 전환 후 정리
    1. migration lifecycle 에 cutover complete 인지, data replication status 가 disconnected 인지, next step이 archive 인지 확인
    2. 서버를 클릭하고, action 에서 mark as archive 선택. 서버를 보관하여 mgn 콘솔에서 제거하기 위함
    3. 톱니바퀴를 누르면 보관된 서버를 볼 수 있음
